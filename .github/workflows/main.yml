name: Daily Inventory Catalog Updater (Continuous)

on:
  schedule:
    # Run daily at 2:00 AM UTC (adjust timezone as needed)
    - cron: "0 2 * * *"
    
  workflow_dispatch:      # Manual triggering anytime
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

  # CRITICAL: This prevents GitHub from disabling the workflow
  push:
    branches: [ main, master ]
    paths: 
      - '.github/workflows/**'
      - '**.py'
  
  # Keep repository active with minimal commits
  repository_dispatch:
    types: [keep-alive]

env:
  PYTHONUNBUFFERED: 1
  TZ: UTC

jobs:
  inventory-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Repository activity tracker
        run: |
          echo "ğŸ”„ Workflow triggered at: $(date)"
          echo "âš¡ Keeping repository active for continuous automation"
          echo "ğŸ“… Last commit: $(git log -1 --format='%cd' --date=short)"
          echo "ğŸƒ Workflow run number: ${{ github.run_number }}"

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”‘ Set up Google Cloud credentials
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
        run: |
          echo "$GCP_CREDENTIALS" > /tmp/gcp_credentials.json
          python -c "import json; json.load(open('/tmp/gcp_credentials.json'))"
          echo "âœ… GCP credentials validated"

      - name: ğŸ“ Prepare directories
        run: |
          mkdir -p /tmp/raw /tmp/pinterest_output
          ls -la /tmp/

      - name: ğŸš€ Run daily inventory update
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp_credentials.json
          BUCKET_NAME: ${{ vars.BUCKET_NAME || 'sitemaps.leeladiamond.com' }}
          BUCKET_FOLDER: ${{ vars.BUCKET_FOLDER || 'pinterestfinal' }}
          OUTPUT_FOLDER: /tmp/pinterest_output
          FTP_DOWNLOAD_DIR: /tmp/raw
          FTP_SERVER: ${{ vars.FTP_SERVER || 'ftp.nivoda.net' }}
          FTP_PORT: ${{ vars.FTP_PORT || '21' }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          EXCHANGE_RATE_API_KEY: ${{ secrets.EXCHANGE_RATE_API_KEY || '20155ba28afe7c763416cc23' }}
        run: |
          echo "ğŸ”„ Starting daily inventory catalog update..."
          python main.py
          echo "âœ… Daily update completed successfully"

      - name: ğŸ“ˆ Update statistics and keep active
        run: |
          echo "ğŸ“Š Generating activity report..."
          echo "ğŸ• Update completed at: $(date)" >> activity.log
          echo "ğŸ“¦ Files processed: $(find /tmp/pinterest_output -name "*.csv" | wc -l)" >> activity.log
          echo "ğŸ’¾ Output size: $(du -sh /tmp/pinterest_output | cut -f1)" >> activity.log
          
          # Display recent activity
          if [ -f activity.log ]; then
            echo "ğŸ“‹ Recent activity:"
            tail -5 activity.log
          fi

      - name: ğŸ”„ Auto-commit activity log (keeps repo active)
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Create/update activity log
          echo "$(date): Daily inventory update completed - Run #${{ github.run_number }}" >> .github/activity.log
          
          # Only commit if there are changes
          if ! git diff --quiet .github/activity.log 2>/dev/null; then
            git add .github/activity.log
            git commit -m "ğŸ“Š Auto-update: Daily inventory sync $(date +'%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"
            git push || echo "Nothing to push"
          else
            echo "â„¹ï¸ No activity log changes to commit"
          fi

      - name: ğŸ§¹ Clean up credentials
        if: always()
        run: |
          rm -f /tmp/gcp_credentials.json
          echo "ğŸ§¹ Cleaned up temporary credentials"

      - name: ğŸ¯ Success notification
        if: success()
        run: |
          echo "ğŸ‰ Daily inventory update completed successfully!"
          echo "ğŸ“… Next scheduled run: Tomorrow at 2:00 AM UTC"
          echo "ğŸ”„ Workflow will continue running daily automatically"

      - name: âš ï¸ Failure notification  
        if: failure()
        run: |
          echo "âŒ Daily inventory update failed"
          echo "ğŸ”„ Workflow will retry tomorrow at scheduled time"
          echo "ğŸ“ Check logs for error details"

  # Additional job to ensure GitHub doesn't disable the workflow
  keep-alive:
    runs-on: ubuntu-latest
    needs: inventory-update
    if: always()
    
    steps:
      - name: ğŸ“¡ Keep repository active
        run: |
          echo "ğŸ”„ Repository activity maintenance"
          echo "ğŸ“… Last workflow run: $(date)"
          echo "ğŸ¯ Status: ${{ needs.inventory-update.result }}"
          echo "âœ… Workflow remains active for continuous automation"
